from unittest import mock

from rest_framework import status, test

from waldur_openstack import models

from . import factories, fixtures


class FloatingIPListRetrieveTestCase(test.APITransactionTestCase):
    def setUp(self):
        self.fixture = fixtures.OpenStackFixture()
        self.active_ip = factories.FloatingIPFactory(
            runtime_state="ACTIVE",
            service_settings=self.fixture.settings,
            project=self.fixture.project,
        )
        self.down_ip = factories.FloatingIPFactory(
            runtime_state="DOWN",
            service_settings=self.fixture.settings,
            project=self.fixture.project,
        )
        self.other_ip = factories.FloatingIPFactory(runtime_state="UNDEFINED")

    def test_floating_ip_list_can_be_filtered_by_project(self):
        data = {
            "project": self.fixture.project.uuid.hex,
        }
        # when
        self.client.force_authenticate(self.fixture.staff)
        response = self.client.get(factories.FloatingIPFactory.get_list_url(), data)
        # then
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        response_ip_uuids = [ip["uuid"] for ip in response.data]
        expected_ip_uuids = [ip.uuid.hex for ip in (self.active_ip, self.down_ip)]
        self.assertEqual(sorted(response_ip_uuids), sorted(expected_ip_uuids))

    def test_floating_ip_list_can_be_filtered_by_status(self):
        data = {
            "runtime_state": "ACTIVE",
        }
        # when
        self.client.force_authenticate(self.fixture.staff)
        response = self.client.get(factories.FloatingIPFactory.get_list_url(), data)
        # then
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        response_ip_uuids = [ip["uuid"] for ip in response.data]
        expected_ip_uuids = [self.active_ip.uuid.hex]
        self.assertEqual(response_ip_uuids, expected_ip_uuids)

    def test_admin_receive_only_ips_from_his_project(self):
        # when
        self.client.force_authenticate(self.fixture.admin)
        response = self.client.get(factories.FloatingIPFactory.get_list_url())
        # then
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        response_ip_uuids = [ip["uuid"] for ip in response.data]
        expected_ip_uuids = [ip.uuid.hex for ip in (self.active_ip, self.down_ip)]
        self.assertEqual(sorted(response_ip_uuids), sorted(expected_ip_uuids))

    def test_owner_receive_only_ips_from_his_customer(self):
        # when
        self.client.force_authenticate(self.fixture.owner)
        response = self.client.get(factories.FloatingIPFactory.get_list_url())
        # then
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        response_ip_uuids = [ip["uuid"] for ip in response.data]
        expected_ip_uuids = [ip.uuid.hex for ip in (self.active_ip, self.down_ip)]
        self.assertEqual(sorted(response_ip_uuids), sorted(expected_ip_uuids))

    def test_regular_user_does_not_receive_any_ips(self):
        # when
        self.client.force_authenticate(self.fixture.user)
        response = self.client.get(factories.FloatingIPFactory.get_list_url())
        # then
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        response_ip_uuids = [ip["uuid"] for ip in response.data]
        expected_ip_uuids = []
        self.assertEqual(response_ip_uuids, expected_ip_uuids)

    def test_admin_can_retrieve_floating_ip_from_his_project(self):
        # when
        self.client.force_authenticate(self.fixture.admin)
        response = self.client.get(factories.FloatingIPFactory.get_url(self.active_ip))
        # then
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(response.data["uuid"], self.active_ip.uuid.hex)

    def test_owner_can_not_retrieve_floating_ip_not_from_his_customer(self):
        # when
        self.client.force_authenticate(self.fixture.owner)
        response = self.client.get(factories.FloatingIPFactory.get_url(self.other_ip))
        # then
        self.assertEqual(response.status_code, status.HTTP_404_NOT_FOUND)


class BaseFloatingIPTest(test.APITransactionTestCase):
    def setUp(self) -> None:
        self.fixture = fixtures.OpenStackFixture()
        self.ip = self.fixture.floating_ip
        self.port = self.fixture.port
        self.client.force_login(self.fixture.staff)


class FloatingIPRetrieveTest(BaseFloatingIPTest):
    def test_floating_ip_access_from_port(self):
        self.ip.port = self.port
        self.ip.save()
        response = self.client.get(factories.PortFactory.get_url(self.port))
        response_fips = response.data["floating_ips"]
        self.assertEqual([factories.FloatingIPFactory.get_url(self.ip)], response_fips)


class FloatingIPAttachTest(BaseFloatingIPTest):
    def setUp(self) -> None:
        super().setUp()
        self.request_data = {"port": factories.PortFactory.get_url(self.port)}
        self.url = factories.FloatingIPFactory.get_url(self.ip, action="attach_to_port")

    def test_floating_ip_attach(self):
        response = self.client.post(self.url, self.request_data)
        self.assertEqual(response.status_code, status.HTTP_202_ACCEPTED)

    def test_floating_ip_attaching_for_ip_with_not_ok_state(self):
        self.ip.state = models.FloatingIP.States.ERRED
        self.ip.save()
        response = self.client.post(self.url, self.request_data)
        self.assertEqual(response.status_code, status.HTTP_409_CONFLICT)

    @mock.patch("waldur_openstack.executors.FloatingIPAttachExecutor.execute")
    def test_floating_ip_attaching_triggers_executor(
        self, attach_ip_executor_action_mock
    ):
        response = self.client.post(self.url, self.request_data)
        self.assertEqual(response.status_code, status.HTTP_202_ACCEPTED)
        attach_ip_executor_action_mock.assert_called_once()

    def test_floating_ip_attaching_to_port_with_not_ok_state(self):
        self.port.state = models.Port.States.ERRED
        self.port.save()
        response = self.client.post(self.url, self.request_data)
        self.assertEqual(response.status_code, status.HTTP_409_CONFLICT)
        self.assertIn("state", response.data["detail"])

    def test_floating_ip_attaching_to_port_from_different_tenant(self):
        self.port.tenant = factories.TenantFactory()
        self.port.save()
        response = self.client.post(self.url, self.request_data)
        self.assertEqual(response.status_code, status.HTTP_400_BAD_REQUEST)
        self.assertIn("tenant", response.data["detail"])


class FloatingIPDetachTest(BaseFloatingIPTest):
    def setUp(self) -> None:
        super().setUp()
        self.url = factories.FloatingIPFactory.get_url(
            self.ip, action="detach_from_port"
        )
        self.ip.port = self.port
        self.ip.save()

    def test_floating_ip_detach(self):
        response = self.client.post(self.url)
        self.assertEqual(response.status_code, status.HTTP_202_ACCEPTED)

    def test_floating_ip_detaching_for_ip_with_not_ok_state(self):
        self.ip.state = models.FloatingIP.States.ERRED
        self.ip.save()
        response = self.client.post(self.url)
        self.assertEqual(response.status_code, status.HTTP_409_CONFLICT)

    @mock.patch("waldur_openstack.executors.FloatingIPDetachExecutor.execute")
    def test_floating_ip_detaching_triggers_executor(
        self, detach_ip_executor_action_mock
    ):
        response = self.client.post(self.url)
        self.assertEqual(response.status_code, status.HTTP_202_ACCEPTED)
        detach_ip_executor_action_mock.assert_called_once()

    def test_floating_ip_detaching_without_port(self):
        self.ip.port = None
        self.ip.save()
        response = self.client.post(self.url)
        self.assertEqual(response.status_code, status.HTTP_400_BAD_REQUEST)
        self.assertIn("not attached to any port", response.data["port"])


class FloatingIPUpdateTest(BaseFloatingIPTest):
    def setUp(self) -> None:
        super().setUp()
        self.url = factories.FloatingIPFactory.get_url(
            self.ip, action="update_description"
        )
        self.description = "new description"
        self.payload = {"description": self.description}

    def test_floating_ip_description_update(self):
        response = self.client.post(self.url, self.payload)
        self.assertEqual(response.status_code, status.HTTP_202_ACCEPTED)
        self.ip.refresh_from_db()
        self.assertEqual(self.ip.description, self.description)

    @mock.patch("waldur_openstack.executors.FloatingIPUpdateExecutor.execute")
    def test_floating_ip_description_update_triggers_executor(
        self, detach_ip_executor_action_mock
    ):
        response = self.client.post(self.url, self.payload)
        self.assertEqual(response.status_code, status.HTTP_202_ACCEPTED)
        detach_ip_executor_action_mock.assert_called_once()

    def test_floating_ip_description_update_for_ip_with_not_ok_state(self):
        self.ip.state = models.FloatingIP.States.ERRED
        self.ip.save()
        response = self.client.post(self.url, self.payload)
        self.assertEqual(response.status_code, status.HTTP_409_CONFLICT)


class OpenStackFloatingIPGetTest(test.APITransactionTestCase):
    def setUp(self):
        self.fixture = fixtures.OpenStackFixture()
        self.client.force_authenticate(self.fixture.staff)

    def test_instance_information_is_returned_for_associated_floating_ip(self):
        self.fixture.floating_ip.runtime_state = "ACTIVE"
        self.fixture.floating_ip.port = self.fixture.port
        self.fixture.floating_ip.save()

        response = self.client.get(factories.FloatingIPFactory.get_list_url())

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(len(response.data), 1)
        self.assertEqual(response.data[0]["instance_uuid"], self.fixture.instance.uuid)
        self.assertEqual(response.data[0]["instance_name"], self.fixture.instance.name)
        self.assertIn(self.fixture.instance.uuid.hex, response.data[0]["instance_url"])

    def test_instance_information_is_empty_if_floating_ip_service_property_is_missing(
        self,
    ):
        factories.FloatingIPFactory()

        response = self.client.get(factories.FloatingIPFactory.get_list_url())

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(len(response.data), 1)
        self.assertIsNone(response.data[0]["instance_uuid"])
        self.assertIsNone(response.data[0]["instance_name"])
        self.assertIsNone(response.data[0]["instance_url"])
